<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Club Reading Poll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .book-select-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .book-select-card.selected {
            border-color: #3b82f6;
            transform: scale(1.03);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .book-choice-card {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .book-choice-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        #comparison-container {
            perspective: 1000px;
        }
        .card-enter-active {
            animation: flip-in 0.6s ease-out both;
        }
        @keyframes flip-in {
            from {
                transform: rotateY(-90deg) scale(0.9);
                opacity: 0;
            }
            to {
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .highlight-top-4 {
            background-color: #e0f2fe;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- Step 0: Name Section -->
        <div id="name-section">
             <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Book Club Poll</h1>
                <p class="mt-2 text-lg text-gray-600">Please enter your name to vote.</p>
            </header>
            <div class="max-w-sm mx-auto">
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <p id="name-error" class="mt-1 text-red-500 font-medium h-5"></p>
                <button id="start-voting-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 text-lg">Start Voting</button>
            </div>
        </div>

        <!-- Step 1: Selection Section -->
        <div id="selection-section" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Step 1: Top Picks</h1>
                <p class="mt-2 text-lg text-gray-600">First, select up to 5 books you definitely want to read.</p>
                <p id="selection-counter" class="mt-2 font-semibold text-blue-600">0 of 5 selected</p>
                <p id="selection-message" class="mt-1 text-red-500 font-medium h-5"></p>
            </header>
            <div id="book-selection-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div class="text-center mt-8">
                 <button id="continue-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 text-lg">Continue</button>
            </div>
        </div>

        <!-- Step 2: Polling Section -->
        <div id="polling-section" class="hidden max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Step 2: Rank The Rest</h1>
                <p class="mt-2 text-lg text-gray-600">Now, help us rank the remaining books. Which would you rather read?</p>
            </header>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm text-gray-500 mb-8">Matchup 1 of X</p>
            <div id="comparison-container" class="grid grid-cols-1 md:grid-cols-2 md:gap-8 items-stretch relative">
                <div id="book-a-container"></div>
                <div class="hidden md:flex items-center justify-center"><span class="text-2xl font-bold text-gray-400">VS</span></div>
                <div id="book-b-container" class="mt-8 md:mt-0"></div>
            </div>
        </div>

        <!-- Step 3: Result Section -->
        <div id="result-section" class="hidden text-center max-w-3xl mx-auto">
             <h1 class="text-4xl font-bold text-gray-900 mb-4">Overall Book Club Rankings</h1>
             <p class="text-lg text-gray-600 mb-2">Thanks for voting, <span id="voter-name-final" class="font-bold"></span>! Here are the current club rankings.</p>
             <p id="voters-count" class="text-md text-gray-500 mb-8"></p>
             <div id="final-rankings" class="text-left bg-white p-6 rounded-lg shadow-md space-y-3"></div>
             <button id="back-to-start-btn" class="mt-8 bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">Start Over</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db, auth;
        let voterName = '';
        let definiteReads = [];
        let booksForComparison = [];
        let pairs = [];
        let currentPairIndex = 0;
        let scores = {};
        
        const MAX_DEFINITE_READS = 5;

        const books = [
            { title: 'At-One-Ment', author: 'Thomas McConkie', suggester: 'John', description: 'Explores spiritual and practical methods for personal and spiritual development.' },
            { title: 'The Woman they could not silence', author: 'Kate Moore', suggester: 'Benjamin', description: 'The true story of a woman committed to an asylum for her outspoken nature.' },
            { title: 'High Conflict', author: 'Amanda Ripley', suggester: 'Andrew', description: 'Examines the nature of conflict and how to manage it.' },
            { title: 'Into the magic shop', author: 'James Doty', suggester: 'John', description: 'A memoir about a neurosurgeon and the lessons he learned.' },
            { title: 'James', author: 'Percival Everett', suggester: 'John', description: 'Retells the Adventures of Huckleberry Finn from the perspective of Jim, an enslaved person.' },
            { title: 'Being Mortal', author: 'Atul Gawande', suggester: 'Andrew', description: 'Looks at end-of-life care and the process of aging and dying.' },
            { title: 'Against Health', author: 'Jonathan Metzl', suggester: 'Andrew', description: 'A critical look at the cultural concept of "health" and its social implications.' },
            { title: 'Man\'s Search for Meaning', author: 'Viktor Frankl', suggester: 'Benjamin', description: 'A man\'s experiences in a Nazi concentration camp.' },
            { title: 'All the Living and the Dead', author: 'Hayley Campbell', suggester: 'Benjamin', description: 'A journalistic look at the work of people who deal with death and the deceased.' },
            { title: 'Just Mercy', author: 'Bryan Stevenson', suggester: 'Benjamin', description: 'A memoir about a lawyer\'s work to reform a justice system.' },
            { title: 'Mere Christianity', author: 'CS Lewis', suggester: 'Joseph', description: 'Provides a logical and accessible argument for the core principles that unite all Christians.' },
            { title: 'A Life on Our Planet', author: 'Sir David Attenborough', suggester: 'Joseph', description: 'A witness statement from a naturalist about the environment and its future.' },
        ];
        
        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const nameSection = document.getElementById('name-section');
        const selectionSection = document.getElementById('selection-section');
        const pollingSection = document.getElementById('polling-section');
        const resultSection = document.getElementById('result-section');
        const nameInput = document.getElementById('name-input');
        const nameError = document.getElementById('name-error');
        const startVotingBtn = document.getElementById('start-voting-btn');
        const bookSelectionGrid = document.getElementById('book-selection-grid');
        const selectionCounter = document.getElementById('selection-counter');
        const selectionMessage = document.getElementById('selection-message');
        const continueBtn = document.getElementById('continue-btn');
        const bookAContainer = document.getElementById('book-a-container');
        const bookBContainer = document.getElementById('book-b-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        let messageTimeout;

        // --- UI Functions ---
        function showSection(section) {
            [nameSection, selectionSection, pollingSection, resultSection].forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');
        }

        function showTemporaryMessage(el, message) {
            el.textContent = message;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                el.textContent = '';
            }, 3000);
        }
        
        // --- Initialization ---
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-club-poll';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                loadingSpinner.classList.add('hidden');
                showSection(nameSection);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingSpinner.innerHTML = `<p class="text-red-500">Error: Could not connect to the database.</p>`;
            }
        }
        
        window.onload = initializeFirebase;

        // --- Step 0: Name Logic ---
        startVotingBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (!name) {
                showTemporaryMessage(nameError, "Please enter your name.");
                return;
            }
            voterName = name;
            
            const voterRef = doc(db, `artifacts/${appId}/public/data/bookClubVoters`, voterName);
            const voterSnap = await getDoc(voterRef);

            if (voterSnap.exists()) {
                showTemporaryMessage(nameError, "It looks like you've already voted. Showing results.");
                setTimeout(() => displayAggregateResults(), 2000);
            } else {
                initializeSelection();
            }
        });

        // --- Step 1: Selection Logic ---
        function initializeSelection() {
            showSection(selectionSection);
            definiteReads = [];
            bookSelectionGrid.innerHTML = '';
            
            books.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-select-card bg-white p-4 rounded-lg shadow-sm border h-full';
                card.dataset.title = book.title;
                card.innerHTML = `<p class="font-bold text-md">${book.title}</p><p class="text-sm text-gray-600">by ${book.author}</p><p class="text-xs text-gray-500 mt-2">${book.description}</p>`;
                card.addEventListener('click', () => handleBookSelection(card, book.title));
                bookSelectionGrid.appendChild(card);
            });
            updateSelectionCounter();
        }

        function handleBookSelection(card, title) {
            const index = definiteReads.indexOf(title);
            if (index > -1) {
                definiteReads.splice(index, 1);
                card.classList.remove('selected');
            } else {
                if (definiteReads.length < MAX_DEFINITE_READS) {
                    definiteReads.push(title);
                    card.classList.add('selected');
                } else {
                    showTemporaryMessage(selectionMessage, `You can only select up to ${MAX_DEFINITE_READS} books.`);
                }
            }
            updateSelectionCounter();
        }

        function updateSelectionCounter() {
            selectionCounter.textContent = `${definiteReads.length} of ${MAX_DEFINITE_READS} selected`;
        }
        
        continueBtn.addEventListener('click', () => {
            if (definiteReads.length >= MAX_DEFINITE_READS) {
                booksForComparison = [];
                scores = {};
                submitVoteAndShowResults();
                return;
            }
            booksForComparison = books.filter(book => !definiteReads.includes(book.title));
            if (booksForComparison.length < 2) {
                scores = {};
                submitVoteAndShowResults();
            } else {
                startComparisonPoll();
            }
        });

        // --- Step 2: Comparison Poll Logic ---
        function startComparisonPoll() {
            showSection(pollingSection);
            generatePairs();
            currentPairIndex = 0;
            scores = booksForComparison.reduce((acc, book) => ({ ...acc, [book.title]: 0 }), {});
            displayPair();
        }
        
        function generatePairs() {
            pairs = [];
            for (let i = 0; i < booksForComparison.length; i++) {
                for (let j = i + 1; j < booksForComparison.length; j++) {
                    pairs.push([booksForComparison[i], booksForComparison[j]]);
                }
            }
            for (let i = pairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
            }
            const maxComparisons = Math.min(pairs.length, Math.ceil(booksForComparison.length * 1.5));
            if (pairs.length > maxComparisons) pairs = pairs.slice(0, maxComparisons);
        }
        
        function displayPair() {
            if (currentPairIndex >= pairs.length) {
                submitVoteAndShowResults();
                return;
            }
            const [bookA, bookB] = pairs[currentPairIndex];
            bookAContainer.innerHTML = '';
            bookBContainer.innerHTML = '';
            const cardA = createComparisonCard(bookA);
            const cardB = createComparisonCard(bookB);
            cardA.classList.add('card-enter-active');
            cardB.classList.add('card-enter-active');
            cardB.style.animationDelay = '0.1s';
            bookAContainer.appendChild(cardA);
            bookBContainer.appendChild(cardB);
            updateProgress();
        }

        function createComparisonCard(book) {
            const card = document.createElement('div');
            card.className = 'book-choice-card bg-white p-6 rounded-lg shadow-md border h-full flex flex-col justify-between';
            card.innerHTML = `<div><p class="font-bold text-xl">${book.title}</p><p class="text-md text-gray-600">by ${book.author}</p><p class="text-sm text-gray-500 mt-4">${book.description}</p></div><p class="text-xs text-gray-400 mt-4 text-right">Suggested by: ${book.suggester}</p>`;
            card.addEventListener('click', () => handleChoice(book.title));
            return card;
        }

        function handleChoice(winnerTitle) {
            scores[winnerTitle]++;
            currentPairIndex++;
            displayPair();
        }
        
        function updateProgress() {
            const percentage = pairs.length > 0 ? (currentPairIndex / pairs.length) * 100 : 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = pairs.length > 0 ? `Matchup ${currentPairIndex + 1} of ${pairs.length}` : 'Done!';
        }

        // --- Step 3: Results & Data Submission ---
        async function submitVoteAndShowResults() {
            loadingSpinner.classList.remove('hidden');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-club-poll';
            
            const rankedComparisonBooks = booksForComparison.sort((a, b) => (scores[b.title] || 0) - (scores[a.title] || 0));
            const finalRankedTitles = [...definiteReads, ...rankedComparisonBooks.map(b => b.title)];
            const userTop5 = finalRankedTitles.slice(0, 5);

            try {
                // Set voter document to prevent re-voting
                const voterRef = doc(db, `artifacts/${appId}/public/data/bookClubVoters`, voterName);
                await setDoc(voterRef, { votedAt: new Date() });

                // Update aggregate scores in a transaction
                const rankingsRef = doc(db, `artifacts/${appId}/public/data/bookClubRankings`, "allVotes");
                await runTransaction(db, async (transaction) => {
                    const rankingsDoc = await transaction.get(rankingsRef);
                    const currentScores = rankingsDoc.exists() ? rankingsDoc.data().scores : {};
                    
                    userTop5.forEach((title, index) => {
                        const points = 5 - index; // 5 for 1st, 4 for 2nd, etc.
                        currentScores[title] = (currentScores[title] || 0) + points;
                    });
                    
                    transaction.set(rankingsRef, { scores: currentScores });
                });

                displayAggregateResults();

            } catch (error) {
                console.error("Error submitting vote: ", error);
                loadingSpinner.innerHTML = `<p class="text-red-500">Could not submit your vote. Please try again.</p>`;
            }
        }

        async function displayAggregateResults() {
            loadingSpinner.classList.remove('hidden');
            showSection(resultSection);
            document.getElementById('voter-name-final').textContent = voterName;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-club-poll';

            const rankingsRef = doc(db, `artifacts/${appId}/public/data/bookClubRankings`, "allVotes");
            const rankingsSnap = await getDoc(rankingsRef);
            const scores = rankingsSnap.exists() ? rankingsSnap.data().scores : {};

            const votersColRef = collection(db, `artifacts/${appId}/public/data/bookClubVoters`);
            const votersSnapshot = await getDocs(votersColRef);
            document.getElementById('voters-count').textContent = `Based on ${votersSnapshot.size} vote(s).`;

            const sortedBooks = books
                .map(book => ({ ...book, score: scores[book.title] || 0 }))
                .sort((a, b) => b.score - a.score);

            const finalRankingsContainer = document.getElementById('final-rankings');
            finalRankingsContainer.innerHTML = '';
            
            if (sortedBooks.length === 0 || sortedBooks.every(b => b.score === 0)) {
                finalRankingsContainer.innerHTML = '<p class="text-gray-500">No votes have been cast yet.</p>';
                loadingSpinner.classList.add('hidden');
                return;
            }

            sortedBooks.forEach((book, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'p-3 rounded-md flex items-center justify-between';
                if (index < 4) {
                    rankItem.classList.add('highlight-top-4');
                }
                rankItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-lg font-bold text-gray-500 w-8">${index + 1}.</span>
                        <div>
                            <p class="font-semibold text-lg">${book.title}</p>
                            <p class="text-sm text-gray-600">by ${book.author}</p>
                        </div>
                    </div>
                    <span class="font-bold text-blue-600 text-lg">${book.score} pts</span>
                `;
                finalRankingsContainer.appendChild(rankItem);
            });
            loadingSpinner.classList.add('hidden');
        }

        document.getElementById('back-to-start-btn').addEventListener('click', () => {
             showSection(nameSection);
             nameInput.value = '';
        });

    </script>
</body>
</html>

