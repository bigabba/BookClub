<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Club Reading Poll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .book-select-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .book-select-card.selected {
            border-color: #3b82f6;
            transform: scale(1.03);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .book-choice-card {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .book-choice-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        #comparison-container {
            perspective: 1000px;
        }
        .card-enter-active {
            animation: flip-in 0.6s ease-out both;
        }
        @keyframes flip-in {
            from {
                transform: rotateY(-90deg) scale(0.9);
                opacity: 0;
            }
            to {
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- Step 1: Selection Section -->
        <div id="selection-section">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Book Club Poll: Top Picks</h1>
                <p class="mt-2 text-lg text-gray-600">First, select up to 5 books you definitely want to read.</p>
                <p id="selection-counter" class="mt-2 font-semibold text-blue-600">0 of 5 selected</p>
                <p id="selection-message" class="mt-1 text-red-500 font-medium h-5"></p>
            </header>
            <div id="book-selection-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Book selection cards will be injected here -->
            </div>
            <div class="text-center mt-8">
                 <button id="continue-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 text-lg">Continue</button>
            </div>
        </div>

        <!-- Step 2: Polling Section -->
        <div id="polling-section" class="hidden max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Rank The Rest</h1>
                <p class="mt-2 text-lg text-gray-600">Now, help us rank the remaining books. Which would you rather read?</p>
            </header>

            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm text-gray-500 mb-8">Matchup 1 of X</p>
            
            <div id="comparison-container" class="grid grid-cols-1 md:grid-cols-2 md:gap-8 items-stretch relative">
                <div id="book-a-container"></div>
                <div class="hidden md:flex items-center justify-center"><span class="text-2xl font-bold text-gray-400">VS</span></div>
                <div id="book-b-container" class="mt-8 md:mt-0"></div>
            </div>
        </div>

        <!-- Step 3: Result Section -->
        <div id="result-section" class="hidden text-center max-w-2xl mx-auto">
             <h1 class="text-4xl font-bold text-gray-900 mb-4">Your Top 5 Choices!</h1>
             <p class="text-lg text-gray-600 mb-8">Based on your selections, here are your top 5 book recommendations. Please share this list with the book club organizer.</p>
             <div id="final-rankings" class="text-left bg-white p-6 rounded-lg shadow-md"></div>
             <button id="back-to-start-btn" class="mt-8 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">Start Over</button>
        </div>
    </div>

    <script>
        const books = [
            { title: 'At-One-Ment', author: 'Thomas McConkie', suggester: 'John', description: 'Explores spiritual and practical methods for personal and spiritual development.' },
            { title: 'The Woman they could not silence', author: 'Kate Moore', suggester: 'Benjamin', description: 'The true story of a woman committed to an asylum for her outspoken nature.' },
            { title: 'High Conflict', author: 'Amanda Ripley', suggester: 'Andrew', description: 'Examines the nature of conflict and how to manage it.' },
            { title: 'Into the magic shop', author: 'James Doty', suggester: 'John', description: 'A memoir about a neurosurgeon and the lessons he learned.' },
            { title: 'James', author: 'Percival Everett', suggester: 'John', description: 'Retells the Adventures of Huckleberry Finn from the perspective of Jim, an enslaved person.' },
            { title: 'Being Mortal', author: 'Atul Gawande', suggester: 'Andrew', description: 'Looks at end-of-life care and the process of aging and dying.' },
            { title: 'Against Health', author: 'Jonathan Metzl', suggester: 'Andrew', description: 'A critical look at the cultural concept of "health" and its social implications.' },
            { title: 'Man\'s Search for Meaning', author: 'Viktor Frankl', suggester: 'Benjamin', description: 'A man\'s experiences in a Nazi concentration camp.' },
            { title: 'All the Living and the Dead', author: 'Hayley Campbell', suggester: 'Benjamin', description: 'A journalistic look at the work of people who deal with death and the deceased.' },
            { title: 'Just Mercy', author: 'Bryan Stevenson', suggester: 'Benjamin', description: 'A memoir about a lawyer\'s work to reform a justice system.' },
            { title: 'Mere Christianity', author: 'CS Lewis', suggester: 'Joseph', description: 'Provides a logical and accessible argument for the core principles that unite all Christians.' },
            { title: 'A Life on Our Planet', author: 'Sir David Attenborough', suggester: 'Joseph', description: 'A witness statement from a naturalist about the environment and its future.' },
        ];

        let definiteReads = [];
        let booksForComparison = [];
        let pairs = [];
        let currentPairIndex = 0;
        let scores = {};

        const MAX_DEFINITE_READS = 5;

        // --- DOM Elements ---
        const selectionSection = document.getElementById('selection-section');
        const pollingSection = document.getElementById('polling-section');
        const resultSection = document.getElementById('result-section');
        const bookSelectionGrid = document.getElementById('book-selection-grid');
        const selectionCounter = document.getElementById('selection-counter');
        const continueBtn = document.getElementById('continue-btn');
        const bookAContainer = document.getElementById('book-a-container');
        const bookBContainer = document.getElementById('book-b-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const selectionMessage = document.getElementById('selection-message');
        let messageTimeout;
        
        // --- Core Functions ---

        function showTemporaryMessage(message) {
            selectionMessage.textContent = message;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                selectionMessage.textContent = '';
            }, 2500);
        }

        function initializeSelection() {
            selectionSection.classList.remove('hidden');
            pollingSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            
            definiteReads = [];
            bookSelectionGrid.innerHTML = '';
            
            books.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-select-card bg-white p-4 rounded-lg shadow-sm border h-full';
                card.dataset.title = book.title;
                card.innerHTML = `
                    <p class="font-bold text-md">${book.title}</p>
                    <p class="text-sm text-gray-600">by ${book.author}</p>
                    <p class="text-xs text-gray-500 mt-2">${book.description}</p>
                `;
                card.addEventListener('click', () => handleBookSelection(card, book.title));
                bookSelectionGrid.appendChild(card);
            });
            updateSelectionCounter();
        }

        function handleBookSelection(card, title) {
            const index = definiteReads.indexOf(title);
            if (index > -1) {
                definiteReads.splice(index, 1);
                card.classList.remove('selected');
            } else {
                if (definiteReads.length < MAX_DEFINITE_READS) {
                    definiteReads.push(title);
                    card.classList.add('selected');
                } else {
                    showTemporaryMessage(`You can only select up to ${MAX_DEFINITE_READS} books.`);
                }
            }
            updateSelectionCounter();
        }

        function updateSelectionCounter() {
            selectionCounter.textContent = `${definiteReads.length} of ${MAX_DEFINITE_READS} selected`;
        }
        
        continueBtn.addEventListener('click', () => {
            selectionSection.classList.add('hidden');

            // If user already selected the max number of books, go straight to results.
            if (definiteReads.length >= MAX_DEFINITE_READS) {
                booksForComparison = [];
                scores = {};
                showFinalResults();
                return; // Important to exit here
            }

            booksForComparison = books.filter(book => !definiteReads.includes(book.title));

            // If there aren't enough books left to compare, also go to results.
            if (booksForComparison.length < 2) {
                scores = {}; // Ensure scores are reset
                showFinalResults();
            } else {
                startComparisonPoll();
            }
        });

        function startComparisonPoll() {
            pollingSection.classList.remove('hidden');
            generatePairs();
            currentPairIndex = 0;
            scores = booksForComparison.reduce((acc, book) => {
                acc[book.title] = 0;
                return acc;
            }, {});
            displayPair();
        }
        
        function generatePairs() {
            pairs = [];
            for (let i = 0; i < booksForComparison.length; i++) {
                for (let j = i + 1; j < booksForComparison.length; j++) {
                    pairs.push([booksForComparison[i], booksForComparison[j]]);
                }
            }
            // Shuffle and cap comparisons
            for (let i = pairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
            }
            // Dynamically cap the number of comparisons to make it more efficient.
            const numBooksToCompare = booksForComparison.length;
            // We use a heuristic to get a good ranking without excessive comparisons.
            const maxComparisons = Math.min(pairs.length, Math.ceil(numBooksToCompare * 1.5));
            if (pairs.length > maxComparisons) {
                pairs = pairs.slice(0, maxComparisons);
            }
        }
        
        function displayPair() {
            if (currentPairIndex >= pairs.length) {
                showFinalResults();
                return;
            }
            const [bookA, bookB] = pairs[currentPairIndex];
            bookAContainer.innerHTML = '';
            bookBContainer.innerHTML = '';
            const cardA = createComparisonCard(bookA);
            const cardB = createComparisonCard(bookB);
            cardA.classList.add('card-enter-active');
            cardB.classList.add('card-enter-active');
            cardB.style.animationDelay = '0.1s';
            bookAContainer.appendChild(cardA);
            bookBContainer.appendChild(cardB);
            updateProgress();
        }

        function createComparisonCard(book) {
            const card = document.createElement('div');
            card.className = 'book-choice-card bg-white p-6 rounded-lg shadow-md border h-full flex flex-col justify-between';
            card.dataset.title = book.title;
            card.innerHTML = `
                <div>
                    <p class="font-bold text-xl">${book.title}</p>
                    <p class="text-md text-gray-600">by ${book.author}</p>
                    <p class="text-sm text-gray-500 mt-4">${book.description}</p>
                </div>
                <p class="text-xs text-gray-400 mt-4 text-right">Suggested by: ${book.suggester}</p>
            `;
            card.addEventListener('click', () => handleChoice(book.title));
            return card;
        }

        function handleChoice(winnerTitle) {
            scores[winnerTitle]++;
            currentPairIndex++;
            displayPair();
        }
        
        function updateProgress() {
            const percentage = pairs.length > 0 ? (currentPairIndex / pairs.length) * 100 : 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = pairs.length > 0 ? `Matchup ${currentPairIndex + 1} of ${pairs.length}` : 'Done!';
        }

        function showFinalResults() {
            pollingSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            const rankedComparisonBooks = booksForComparison.sort((a, b) => (scores[b.title] || 0) - (scores[a.title] || 0));
            const finalRankedTitles = [...definiteReads, ...rankedComparisonBooks.map(b => b.title)];
            const top5Titles = finalRankedTitles.slice(0, 5);
            
            const finalRankingsContainer = document.getElementById('final-rankings');
            finalRankingsContainer.innerHTML = '';
            const list = document.createElement('ol');
            list.className = 'list-decimal list-inside space-y-3';

            top5Titles.forEach(title => {
                const book = books.find(b => b.title === title);
                const listItem = document.createElement('li');
                listItem.className = 'text-lg';
                listItem.innerHTML = `<span class="font-semibold">${book.title}</span> <span class="text-gray-500">by ${book.author}</span>`;
                list.appendChild(listItem);
            });
            finalRankingsContainer.appendChild(list);
        }

        document.getElementById('back-to-start-btn').addEventListener('click', () => {
            initializeSelection();
        });

        // Initial setup
        initializeSelection();
    </script>
</body>
</html>